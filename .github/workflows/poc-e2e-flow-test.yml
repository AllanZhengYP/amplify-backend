# Description: This workflow mimic the flow of behaviors when user using Amplify CLI;

name: 'poc-e2e-flow-test'

on: # TODO: need to change the trigger
  push:
    branches:
      - poc/e2e-test

jobs:
  install:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # version 3.6.0
      - uses: ./.github/actions/setup_node
      - uses: ./.github/actions/install_with_cache
  build:
    runs-on: ubuntu-latest
    needs:
      - install
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # version 3.6.0
      - uses: ./.github/actions/setup_node
      - uses: ./.github/actions/build_with_cache
  run_e2e_tests:
    strategy:
      # will finish running other test matrices even if one fails
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        pkg-manager: [npm, yarn, yarn-stable, pnpm]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    needs:
      - build
    permissions:
      # these permissions are required for the configure-aws-credentials action to get a JWT from GitHub
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # version 3.6.0
      - uses: ./.github/actions/setup_node
      - uses: ./.github/actions/restore_build_cache
      - name: Run E2E tests
        run: |
          npm install -g ${{matrix.pkg-manager}}
          echo "$(${{matrix.pkg-manager}}) config set registry http://localhost:4873"
          ${{matrix.pkg-manager}} config set registry http://localhost:4873
          echo "$(${{matrix.pkg-manager}}) config get registry"
          ${{matrix.pkg-manager}} config get registry
          npm run test:dir packages/integration-tests/src/test-e2e/create_amplify.test.ts

# jobs:
#   install:
#     strategy:
#       matrix:
#         os: [ubuntu-latest, macos-latest, windows-latest]
#     runs-on: ${{ matrix.os }}
#     steps:
#       - name: Checkout aws-amplify/amplify-cli repo
#         uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # version 3.6.0
#         with:
#           ref: poc/e2e-test
#       - name: Setup Node.js
#         uses: ./.github/actions/setup_node
#       - name: Install or Restore Cache
#         uses: ./.github/actions/install_with_cache
#   build:
#     runs-on: ubuntu-latest
#     needs:
#       - install
#     steps:
#       - name: Checkout aws-amplify/amplify-cli repo
#         uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # version 3.6.0
#         with:
#           ref: poc/e2e-test
#       - name: Setup Node.js
#         uses: ./.github/actions/setup_node
#       - name: Build or Restore Build Cache
#         uses: ./.github/actions/build_with_cache
#   create-amplify-project:
#     strategy:
#       fail-fast: false
#       matrix:
#         os: [ubuntu-latest, windows-latest, macOS-latest]
#         node-version: [18]
#         pkg-manager: [npm, yarn, yarn-stable, pnpm]
#     runs-on: ${{ matrix.os }}
#     needs:
#       - build
#     env:
#       PACKAGE_MANAGER_EXECUTABLE: ${{ matrix.pkg-manager }} # TODO: remove PACKAGE_MANAGER_EXECUTABLE once CLI is able to getPackageManager().
#     steps:
#       - name: Checkout aws-amplify/amplify-cli repo
#         uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1. TODO: try only fetch .github/workflow
#         with:
#           ref: poc/e2e-test
#       - name: Setup Node.js
#         uses: actions/setup-node@8f152de45cc393bb48ce5d89d36b731f54556e65 #4.0.0
#         with:
#           cache: npm
#       - name: Restore Build Cache
#         uses: ./.github/actions/restore_build_cache
#       - name: Build
#         shell: bash
#         run: npm run install:local && npm run build
#       - name: ${{matrix.pkg-manager}}-create-amplify-project
#         if: matrix.pkg-manager != 'yarn-stable'
#         shell: bash
#         run: |
#           npm install -g ${{matrix.pkg-manager}}
#           echo "$(${{matrix.pkg-manager}}) config set registry http://localhost:4873"
#           ${{matrix.pkg-manager}} config set registry http://localhost:4873
#           echo "$(${{matrix.pkg-manager}}) config get registry"
#           ${{matrix.pkg-manager}} config get registry
#           npm run test:dir packages/integration-tests/src/test-e2e/create_amplify.test.ts

# - name: yarn-stable-create-amplify-project
#   if: matrix.pkg-manager == 'yarn-stable'
#   shell: bash
#   run: |
#     mkdir -p /tmp/amplify-project; cd /tmp/amplify-project
#     corepack enable
#     echo "yarn set version stable"
#     yarn set version stable
#     echo "yarn version $(yarn --version)"
#     yarn config set unsafeHttpWhitelist localhost
#     yarn config set npmRegistryServer http://localhost:4873
#     PACKAGE_MANAGER_EXECUTABLE=yarn npm run test:dir packages/integration-tests/src/test-e2e/create_amplify.test.ts
